# FreeCAD Notes

Notes:

* Setting up tool bits isn't included here. See the [CAM Tools docs](https://wiki.freecad.org/CAM_Tools) for how to do that, and do it.
* Remember to save early and often.
* FreeCAD's default "CAD" style navigation, using icons to rotate the model, feels a bit archaic. There are a number of [mouse navigation](https://wiki.freecad.org/Mouse_navigation) methods, but I find that "Gesture" (which lets you rotate the model in 3D space by holding the left mouse button) feels the most modern and natural. This can be changed via the bottom right status bar, which by default probably has a mouse icon and says "CAD".
* I'm running Arch Linux which has Python 3.12; as of this writing I'm running the 0.21.2 release of FreeCAD. There are some bugs with Python 3.12 and this FreeCAD version which should have been fixed in https://github.com/FreeCAD/FreeCAD/pull/13337 but haven't been released yet. Specifically, trying to generate our Mach3/Mach4 GCode will fail with an error of `name 'pythonopen' is not defined` localized to `File "/usr/lib/freecad/Mod/Path/Path/Post/scripts/mach3_mach4_post.py", line 294, in export`. The simple way around that is to manually patch the file in question by replacing it with [the version from that PR](https://raw.githubusercontent.com/dov/FreeCAD/e188c9b2161220d931b2e2861dd8fb081a101f9c/src/Mod/CAM/Path/Post/scripts/mach3_mach4_post.py). You will need to restart FreeCAD after doing this.

We're going to do the Front Panel first - it's profiled out of the stock and has a large profiled hole in the center, and also has a groove along each edge of the front face.

1. Ensure the drawing in OpenSCAD meets the following:
    1. All dimensions are multiplied by 24.5; FreeCAD will unfortunately import the OpenSCAD drawing as if it were dimensioned in mm, even when you tell FreeCAD to use inches. Left alone, this will result in a part that is 25x too small.
    2. Ensure that all cuts/subtractions go fully through the part and do not have any co-incident surfaces. For example, if you cut a slot in a part and the top of the slot is exactly even with the top of the part (instead of above it), FreeCAD will not properly "see" the slot. Ensure that all subtractions extend past surfaces. An easy way to confirm this other than looking for artifacts in the preview render, is to use the `#` [debug modifier](https://en.wikibooks.org/wiki/OpenSCAD_User_Manual/Modifier_Characters#Debug_Modifier).
    3. Don't use the `hull()` function, it messes up FreeCAD. Similarly that means you have to be very judicious about what libraries you use, especially for things like rounded corners, chamfers and fillets.
    4. Ensure that your model is set up with the _top_ of your _stock material_ at Z=0. The touch block homing process that we use on the DM CNC sets the origin (0,0,0) to the left, front, top corner of your stock. Everything hereafter will go a lot easier if your model also matches that origin.
2. Save the part from OpenSCAD. Since FreeCAD _can_ mutate the part, you should really back this up somewhere - or even better, commit it to a git repo.
3. Open FreeCAD. Go to `Edit -> Preferences -> General -> General` and set your unit system to `Imperial decimal (in, lb)` and set number of decimals to 4.
4. Start a new document in FreeCAD and File -> Open your `.scad` project. You should see it in FreeCAD.
5. If you want to confirm your final dimensions, or you have another use for dimensioned drawings, you can use the TechDraw workbench to make some dimensioned drawings. This is completely optional and likely unnecessary unless you're unsure that your OpenSCAD dimensions are correct or you need to do additional work on the part after CNC.
6. Switch to the Path workbench. Path -> Toolbit library editor and confirm your tool bits are set up (note that feed rates are specified elsewhere, we'll check later).
7. Select the top-level model (for OpenSCAD, this is usually a difference or union or intersection) and click the "Job" toolbar icon, or use Path -> Job.
    1. The Job Edit dialog should open to the "Setup" tab, "Layout" section. First, under "Stock", change from "Extend Model's Bounding Box" to "Create Box" - this will create our stock piece. Enter the dimensions of your stock. You should now see a cube of black lines around your model, representing the stock. Use the perspective controls to ensure that your origin (the vertex of colored arrows, with a colored ball over it) is in the right place. You can then select a point or edge on your model and use the "Alignment", "Set", and "Move" / "Rotate" tools to move the model position in the stock.
    2. Under the "Layout" panel, the "Default Values" panel will allow you to change defaults for start and final depths, step down, and clearance and safe tool heights, if you want to change the defaults.
    3. Go to the "Tools" tab. Here you need to define "Tool Controllers" (TCs) which are distinct stes of feeds and speeds that associate with specific tool bits. Remove the default tool controller. Click add and add one for one of the tools you plan on using. When done adding tools, click the "Default Values" panel to set up rapid speeds if desired; I set 1000 for horizontal and 300 for vertical because I'm impatient and like buying end mills.
    4. On the "Output" tab, change Processor to `mach3_mach4`.
    5. On the "General" tab, you can give the job a label/name.
    6. To allow yourself to skip steps 1-5 next time, click the "Template Export" panel and check off everything except stock and click Export. Save that template.
    7. Finally, click "OK" above the Job Edit task.
8. Now we'll make our first toolpath, for cutting the circle out of the middle.
    1. Select the inner face of the circle.
    2. Click the Profile toolbar icon (Path -> Profile) and select the 1/4" end mill.
    3. In the resulting profile task dialog, ensure Cut Side is set to Inside. "Use Compensation" (compensate for cutter diameter) and "Process Perimeter" should be checked. Unless you want to change the start/end depths or step-down, nothing else to do here; click "OK".
    4. You should now have a tool path showing up in green. **NOTE** that the tool path will show up offset from your model. This is normal and appears to be a minor bug in FreeCAD where the toolpath simulation doesn't take into account the difference between the stock origin and the model origin. Don't worry about it, it might look weird, but the toolpath simulation and your GCode will be fine.
    5. In the Model tree view, click to expand "Operations" and select "Profile". In the Data table, change its Label to something more helpful like "ProfileCircle".
    6. Right click the ProfileCircle operation and select `Tag` to generate tabs ("Tags" in FreeCAD). I changed the defaults a bit to give me six (6) tabs, 2.5" wide and 0.25" high. After changing the number of tabs (in the `Auto Generate` section) click "Replace All" to regenerate the tabs. Click OK.
    7. The previous step will have generated a new item in the Operations tree, beginning with "DressupTag" and with our the ProfileCircle operation nested under it. Right click the new "e Pocket Shape icon (Path -> Pocket Shape). 222222222222DressupTag" operation and select "RampEntry" to create a ramp-in. You should now have a "RampEntryDressup" with a "DressupTag" nested under it and a "ProfileCircle" nested under that. Make absolutely sure all three of these are nested; if not, you'll cut the same toolpath twice, once with tags and again with a ramp-in (which will also remove your tags)!
    8. To make things easier, select the "RampEntryDressup" operation and give it a better name (Label) like "RampEntryCircle".
    9. Click the "CAM Simulator" toolbar icon (Path -> CAM Simulator). Here you can see a simulation of the tool path. You will need to turn the speed WAY down to see anything useful on this small of a tool path - maybe 6G/s or 7G/s. Get a perspective view that you like and click "Play". You should see a tool bit and a simulation of the tool path. Click "OK" when finished to exit the simulator.
    10. You'll now see some annoying brown fill over your model, representing the stock. In the "Combo View" left side of the window, scroll to the bottom of the Model tree and you should see something called `CutMaterial`. This is an artifact generated by the CAM Simulator. Click on it and delete it. Unfortunately you'll need to do this every time you run the simulator.
9. Now we can create the profiling toolpath for the outside of the part.
    1. Select one of the outer faces of the model and then click the "Finish selecting loop" toolbar icon (Path -> Finish selecting loop). On this particular model, you'll get a "Closed loop detection failed" error, but it will still work. All outer faces of the model are now selected.
    2. Click the Profile toolbar icon (Path -> Profile) and select the 1/4" end mill.
    3. In the resulting profile task dialog, change Cut Side to Outside. "Use Compensation" (compensate for cutter diameter) and "Process Perimeter" should be checked. Unless you want to change the start/end depths or step-down, nothing else to do here; click "OK".
    4. You should now have a tool path showing up in green. **NOTE** that the tool path will show up offset from your model. This is normal and appears to be a minor bug in FreeCAD where the toolpath simulation doesn't take into account the difference between the stock origin and the model origin. Don't worry about it, it might look weird, but the toolpath simulation and your GCode will be fine.
    5. In the Model tree view, click to expand "Operations" and select "Profile". In the Data table, change its Label to something more helpful like "ProfilePerimeter".
    6. Right click the ProfilePerimeter operation and select `Tag` to generate tabs ("Tags" in FreeCAD). I changed the defaults a bit to give me eight (8) tabs, 2.5" wide and 0.25" high. After changing the number of tabs (in the `Auto Generate` section) click "Replace All" to regenerate the tabs. Click OK.
    7. The previous step will have generated a new item in the Operations tree, beginning with "DressupTag" and with our the ProfilePerimeter operation nested under it. Right click the new "DressupTag" operation and select "RampEntry" to create a ramp-in. You should now have a "RampEntryDressup" with a "DressupTag" nested under it and a "ProfilePerimeter" nested under that. Make absolutely sure all three of these are nested; if not, you'll cut the same toolpath twice, once with tags and again with a ramp-in (which will also remove your tags)!
    8. To make things easier, select the "RampEntryDressup" operation and give it a better name (Label) like "RampEntryPerimeter".
    9. Click the "CAM Simulator" toolbar icon (Path -> CAM Simulator). Here you can see a simulation of the tool path. You will need to turn the speed WAY down to see anything useful on this small of a tool path - maybe 6G/s or 7G/s. Get a perspective view that you like and click "Play". You should see a tool bit and a simulation of the tool path. Click "OK" when finished to exit the simulator.
    10. You'll now see some annoying brown fill over your model, representing the stock. In the "Combo View" left side of the window, scroll to the bottom of the Model tree and you should see something called `CutMaterial`. This is an artifact generated by the CAM Simulator. Click on it and delete it. Unfortunately you'll need to do this every time you run the simulator.
10. Finally we'll create the pocketing paths for the slots. Note that in FreeCAD, there is a "slot" operation but it's only suitable for slots the exact size as the cutter. We need to use the Pocket operation to create a slot that's wider than the tool.
    1. Select the bottom face of one of the slots. Then Ctrl+click to select the bottom faces of the other three slots. All four should be selected at once.
    2. Click th top bearinge Pocket Shape icon (Path -> Pocket Shape). Change the tool to the 3/16" end mill. Climb cutting is fine, change the pattern from ZigZag to Line because we're cutting a "pocket" (slot) that's less than twice the cutter diameter. Step Over Percent can be 50. Move through the panels of the Pocket Shape task. On the depths panel, let's change "Finish Step Down" to 0.1". On the Extensions panel, we need to set up Extensions in order to fully cut through the corners. Check the Enable Extensions box and then check off all four Wires that represent the ends of each of the through slots. Click the little blue `f(x)` (Function) icon in the top right of the Default Length box and change it from `OpToolDiameter / 2` to `OpToolDiameter`. Click OK.
11. Now we need to fix the order of operations. In the Combo View Model tree, double-click on our "FrontPanel" Job. Select the Workplan tab and we see that the current order is "RampEntryCircle", "RampEntryPerimeter", "Pocket_Shape". Select "Pocket_Shape" and click the up arrow, so that we cut the circle, then the slots (pocket), and finally the perimeter. This sacrifices some finish quality at the ends of the through-slots but gains the rigidity of having the full perimeter intact during slot cutting.
12. Save and run the CAM simulation. The tool paths clearly aren't as optimized for speed as they could be, and we get a 20-minute cycle time. I'll call that acceptable though.
13. Double-click the FrontPanel job again, and on the Output tab set an output filename of `front_panel.gcode` and in the Arguments box enter `--inches` to output GCode in inches instead of mm. Ok, save.
14. Click the Post Process toolbar icon (Path -> Post Process) to generate the GCode.
15. Examine the generated gcode, especially for any X/Y/Z moves that are outside the desired work envelope.

For the other parts, we'll do essentially the same process. Note that we're cutting each part in a separate setup due to the size of our CNC and parts.

For the parts with slots, on the slots, select a bottom edge of the slot then Finish Selecting Loop and Profile.

For the parts with tabs, the easiest way to do this is to select all of the bottom faces (both of the main body and of the tabs) with Ctrl+click and then use the Profile tool, with "Process Perimiter" selected and cut side outside. You will likely want to specify your own tag (holding tab) locations for these.
